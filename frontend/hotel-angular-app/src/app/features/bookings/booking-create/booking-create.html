<div class="booking-create-container">
  <div class="page-header">
    <button mat-icon-button routerLink="/rooms">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <div>
      <h1>Nouvelle Réservation</h1>
      <p>Complétez le formulaire pour réserver votre chambre</p>
    </div>
  </div>

  <div *ngIf="loading && !selectedRoom" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Chargement des informations...</p>
  </div>

  <div *ngIf="!loading && selectedRoom" class="booking-content">
    <div class="booking-form-section">
      <mat-card>
        <mat-card-header>
          <mat-card-title>Détails de la réservation</mat-card-title>
        </mat-card-header>
        
        <mat-card-content>
          <div *ngIf="errorMessage" class="error-message">
            <mat-icon>error</mat-icon>
            {{ errorMessage }}
          </div>

          <form [formGroup]="bookingForm" (ngSubmit)="onSubmit()">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Date d'arrivée</mat-label>
              <input 
                matInput 
                [matDatepicker]="checkInPicker"
                formControlName="checkInDate"
                [min]="minDate"
                placeholder="Sélectionnez la date d'arrivée"
              >
              <mat-datepicker-toggle matSuffix [for]="checkInPicker"></mat-datepicker-toggle>
              <mat-datepicker #checkInPicker></mat-datepicker>
              <mat-error *ngIf="bookingForm.get('checkInDate')?.hasError('required')">
                La date d'arrivée est requise
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Date de départ</mat-label>
              <input 
                matInput 
                [matDatepicker]="checkOutPicker"
                formControlName="checkOutDate"
                [min]="minDate"
                placeholder="Sélectionnez la date de départ"
              >
              <mat-datepicker-toggle matSuffix [for]="checkOutPicker"></mat-datepicker-toggle>
              <mat-datepicker #checkOutPicker></mat-datepicker>
              <mat-error *ngIf="bookingForm.get('checkOutDate')?.hasError('required')">
                La date de départ est requise
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Nombre de personnes</mat-label>
              <input 
                matInput 
                type="number"
                formControlName="numberOfGuests"
                min="1"
                [max]="selectedRoom.capacity"
                placeholder="Nombre de personnes"
              >
              <mat-icon matPrefix>people</mat-icon>
              <mat-hint>Capacité maximale: {{ selectedRoom.capacity }} personne(s)</mat-hint>
              <mat-error *ngIf="bookingForm.get('numberOfGuests')?.hasError('required')">
                Le nombre de personnes est requis
              </mat-error>
              <mat-error *ngIf="bookingForm.get('numberOfGuests')?.hasError('min')">
                Minimum 1 personne
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Demandes spéciales (optionnel)</mat-label>
              <textarea 
                matInput 
                formControlName="specialRequests"
                rows="4"
                placeholder="Ex: Chambre avec vue sur mer, lit bébé, arrivée tardive..."
              ></textarea>
            </mat-form-field>

            <div class="form-actions">
              <button 
                mat-stroked-button 
                type="button"
                routerLink="/rooms"
                [disabled]="loading"
              >
                <mat-icon>close</mat-icon>
                Annuler
              </button>
              <button 
                mat-raised-button 
                color="primary"
                type="submit"
                [disabled]="loading || bookingForm.invalid || totalPrice === 0"
              >
                <mat-spinner *ngIf="loading" diameter="20" class="button-spinner"></mat-spinner>
                <mat-icon *ngIf="!loading">check_circle</mat-icon>
                <span *ngIf="!loading">Confirmer la réservation</span>
              </button>
            </div>
          </form>
        </mat-card-content>
      </mat-card>
    </div>

    <div class="booking-summary-section">
      <mat-card class="summary-card sticky">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>receipt</mat-icon>
            Résumé
          </mat-card-title>
        </mat-card-header>
        
        <mat-card-content>
          <!-- Infos chambre -->
          <div class="room-info">
            <img 
              [src]="selectedRoom.imageUrl || 'assets/default-room.jpg'"
              [alt]="'Chambre ' + selectedRoom.roomNumber"
              (error)="$any($event.target).src='assets/default-room.jpg'"
            >
            <div class="room-details">
              <h3>Chambre {{ selectedRoom.roomNumber }}</h3>
              <p class="room-type">{{ getRoomTypeLabel(selectedRoom.roomType) }}</p>
              <div class="room-features">
                <span>
                  <mat-icon>people</mat-icon>
                  {{ selectedRoom.capacity }} pers.
                </span>
                <span>
                  <mat-icon>layers</mat-icon>
                  Étage {{ selectedRoom.floor }}
                </span>
              </div>
            </div>
          </div>

          <mat-divider></mat-divider>

          <!-- Calcul du prix -->
          <div class="price-details">
            <div class="price-line">
              <span>Prix par nuit</span>
              <span class="price">{{ selectedRoom.pricePerNight | number:'1.2-2' }} DT</span>
            </div>
            
            <div class="price-line" *ngIf="numberOfNights > 0">
              <span>Nombre de nuits</span>
              <span class="price">{{ numberOfNights }} nuit(s)</span>
            </div>

            <div class="price-line" *ngIf="numberOfNights > 0">
              <span>Calcul</span>
              <span class="price">{{ numberOfNights }} × {{ selectedRoom.pricePerNight | number:'1.2-2' }} DT</span>
            </div>

            <mat-divider *ngIf="numberOfNights > 0"></mat-divider>

            <div class="price-line total">
              <span><strong>Total</strong></span>
              <span class="price total-price">
                <strong *ngIf="totalPrice > 0">{{ totalPrice | number:'1.2-2' }} DT</strong>
                <strong *ngIf="totalPrice === 0" style="color: #999;">Sélectionnez les dates</strong>
              </span>
            </div>
          </div>

          <!-- Info paiement -->
          <div class="info-box">
            <mat-icon>info</mat-icon>
            <div>
              <strong>Paiement à l'hôtel</strong>
              <p>Le paiement sera effectué lors de votre arrivée</p>
            </div>
          </div>

          <!-- Politique d'annulation -->
          <div class="policy-box">
            <mat-icon>event_busy</mat-icon>
            <div>
              <strong>Annulation gratuite</strong>
              <p>Vous pouvez annuler jusqu'à 24h avant l'arrivée</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>